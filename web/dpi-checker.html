<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF DPI Checker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f3f5;
            --bg-card: #ffffff;
            --accent-primary: #0969da;
            --accent-secondary: #1a7f37;
            --accent-gradient: #0969da;
            --text-primary: #1f2328;
            --text-secondary: #57606a;
            --text-muted: #8c959f;
            --border-color: #d0d7de;
            --success: #1a7f37;
            --warning: #9a6700;
            --error: #cf222e;
            --shadow-glow: 0 0 60px rgba(9, 105, 218, 0.08);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            font-size: 18px;
        }

        /* Background decoration */
        .bg-decoration {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .bg-decoration::before,
        .bg-decoration::after {
            display: none;
        }

        .grid-pattern {
            display: none;
        }

        /* Main container */
        .container {
            position: relative;
            z-index: 1;
            max-width: 1100px;
            margin: 0 auto;
            padding: 10px 24px;
        }

        /* Header */
        header {
            text-align: center;
            margin-bottom: 10px;
        }

        .logo {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: var(--accent-gradient);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: var(--shadow-glow);
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--accent-primary);
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
            font-weight: 400;
            margin-top: 8px;
        }

        .nav-link {
            display: inline-block;
            margin-top: 16px;
            color: var(--accent-primary);
            text-decoration: none;
            font-size: 0.9rem;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .nav-link:hover {
            opacity: 1;
            text-decoration: underline;
        }

        /* Card */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 28px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05), 0 4px 12px rgba(0, 0, 0, 0.03);
        }

        .card-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 20px;
        }

        /* Drop zone */
        .drop-zone {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 14px 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .drop-zone::before {
            content: '';
            position: absolute;
            inset: 0;
            background: var(--accent-gradient);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .drop-zone:hover {
            border-color: var(--accent-primary);
        }

        .drop-zone:hover::before {
            opacity: 0.03;
        }

        .drop-zone.drag-over {
            border-color: var(--accent-primary);
            border-style: solid;
        }

        .drop-zone.drag-over::before {
            opacity: 0.06;
        }

        .drop-zone-content {
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .drop-icon {
            font-size: 22px;
            opacity: 0.8;
        }

        .drop-text {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .drop-subtext {
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .file-input {
            display: none;
        }

        /* File info */
        .file-info {
            display: none;
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 14px 18px;
            margin-top: 18px;
            align-items: center;
            gap: 14px;
        }

        .file-info.visible {
            display: flex;
        }

        .options-row {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .option-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .option-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--accent-primary);
            cursor: pointer;
        }

        .option-item:hover {
            color: var(--text-primary);
        }

        .file-icon {
            width: 44px;
            height: 44px;
            background: rgba(88, 166, 255, 0.1);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            flex-shrink: 0;
        }

        .file-details {
            flex: 1;
            min-width: 0;
        }

        .file-name {
            font-weight: 500;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.95rem;
        }

        .file-size {
            color: var(--text-muted);
            font-size: 0.8rem;
            margin-top: 2px;
        }

        .file-remove {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: none;
            background: rgba(248, 81, 73, 0.1);
            color: var(--error);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .file-remove:hover {
            background: rgba(248, 81, 73, 0.2);
        }

        /* Button */
        .btn-primary {
            width: 100%;
            padding: 16px 28px;
            background: var(--accent-gradient);
            border: none;
            border-radius: 10px;
            font-family: 'Outfit', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            color: #ffffff;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 20px rgba(9, 105, 218, 0.2);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(9, 105, 218, 0.25);
        }

        .btn-primary:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Progress */
        .progress-container {
            display: none;
            margin-top: 20px;
        }

        .progress-container.visible {
            display: block;
        }

        .progress-bar {
            height: 5px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent-gradient);
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-text {
            font-size: 0.85rem;
            color: var(--text-secondary);
            text-align: center;
        }

        /* Results */
        .results {
            display: none;
        }

        .results.visible {
            display: block;
        }

        /* Summary cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .summary-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
        }

        .summary-card-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .summary-card-hint {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-bottom: 10px;
            font-style: italic;
        }

        .table-hint {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 16px;
            padding: 10px 14px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        /* DPI Distribution Chart */
        .dpi-chart {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 8px;
        }

        .dpi-chart-compact {
            gap: 6px;
            margin-top: 6px;
        }

        .dpi-chart-bar {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dpi-chart-label {
            width: 85px;
            font-size: 0.7rem;
            color: var(--text-secondary);
            flex-shrink: 0;
        }

        .dpi-chart-compact .dpi-chart-label {
            width: 75px;
            font-size: 0.65rem;
        }

        .dpi-chart-track {
            flex: 1;
            height: 18px;
            background: var(--bg-primary);
            border-radius: 3px;
            overflow: hidden;
            position: relative;
        }

        .dpi-chart-compact .dpi-chart-track {
            height: 14px;
        }

        .dpi-chart-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
            min-width: 2px;
        }

        .dpi-chart-fill.dpi-low { background: linear-gradient(90deg, #f85149, #da3633); }
        .dpi-chart-fill.dpi-medium { background: linear-gradient(90deg, #d29922, #bf8700); }
        .dpi-chart-fill.dpi-good { background: linear-gradient(90deg, #58a6ff, #388bfd); }
        .dpi-chart-fill.dpi-high { background: linear-gradient(90deg, #3fb950, #2ea043); }

        .dpi-chart-value {
            width: 50px;
            font-size: 0.75rem;
            font-weight: 600;
            text-align: right;
            font-family: 'JetBrains Mono', monospace;
            flex-shrink: 0;
        }

        .dpi-chart-compact .dpi-chart-value {
            width: 60px;
            font-size: 0.7rem;
        }

        .dpi-chart-value.dpi-low { color: #f85149; }
        .dpi-chart-value.dpi-medium { color: #d29922; }
        .dpi-chart-value.dpi-good { color: #58a6ff; }
        .dpi-chart-value.dpi-high { color: #3fb950; }

        .dpi-chart-empty {
            color: var(--text-muted);
            font-size: 0.75rem;
            text-align: center;
            padding: 10px;
        }

        .summary-table {
            width: 100%;
            font-size: 14px;
        }

        .summary-table tr {
            border-bottom: 1px solid var(--border-color);
        }

        .summary-table tr:last-child {
            border-bottom: none;
        }

        .summary-table td {
            padding: 8px 0;
        }

        .summary-table td:first-child {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .summary-table td:last-child {
            text-align: right;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-primary);
        }

        .summary-table .highlight {
            color: var(--accent-primary);
            font-weight: 600;
        }

        /* Compact summary styles */
        .compact-summary {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .compact-row {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .compact-label {
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-weight: 500;
        }

        .compact-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            color: var(--text-primary);
        }

        .compact-value.highlight {
            color: var(--accent-primary);
            font-weight: 600;
        }

        .compact-sep {
            color: var(--text-muted);
            margin: 0 4px;
        }

        .compact-divider {
            height: 1px;
            background: var(--border-color);
            margin: 4px 0;
        }

        .compact-group {
            display: flex;
            gap: 1px;
            flex-wrap: wrap;
        }

        .dpi-section-label {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
            margin-top: 4px;
        }

        .dpi-section-desc {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .compact-group.dpi-group {
            flex-direction: column;
            gap: 2px;
        }

        .dpi-group .dpi-stat {
            flex-direction: row;
            justify-content: space-between;
            width: 100%;
            min-width: 180px;
            padding: 2px 14px;
        }

        .dpi-group .dpi-stat-value {
            font-size: 1.3rem;
        }

        .dpi-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            min-width: 80px;
            padding: 10px 14px;
            border-radius: 8px;
            background: var(--bg-tertiary);
        }

        .dpi-stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.03em;
            font-weight: 500;
        }

        .dpi-stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .dpi-stat-value.dpi-high {
            color: #3fb950;
        }

        .dpi-stat-value.dpi-good {
            color: #58a6ff;
        }

        .dpi-stat-value.dpi-medium {
            color: #d29922;
        }

        .dpi-stat-value.dpi-low {
            color: #f85149;
        }

        .summary-card-wide {
            grid-column: span 1;
        }

        @media (min-width: 900px) {
            .summary-card-wide {
                grid-column: span 1;
            }
        }

        .largest-images-grid {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .largest-image-item {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 10px;
            padding: 6px 10px;
            background: var(--bg-secondary);
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        .largest-image-thumb {
            width: 36px;
            height: 36px;
            object-fit: contain;
            border-radius: 4px;
            background: var(--bg-tertiary);
            flex-shrink: 0;
        }

        .largest-image-thumb-placeholder {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            border-radius: 4px;
            font-size: 0.9rem;
            color: var(--text-muted);
            flex-shrink: 0;
        }

        .largest-image-info {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.95rem;
            color: var(--text-secondary);
            flex: 1;
        }

        .largest-image-info .page-num {
            font-weight: 600;
            color: var(--accent-primary);
            min-width: 60px;
        }

        .largest-image-info .dims {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .results-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .results-title {
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .results-title-icon {
            font-size: 1.4rem;
        }

        .results-summary {
            display: flex;
            gap: 24px;
            flex-wrap: wrap;
        }

        .summary-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .summary-value {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            color: var(--accent-primary);
        }

        .summary-label {
            color: var(--text-secondary);
        }

        .btn-reset {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 20px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-family: 'Outfit', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-reset:hover {
            border-color: var(--text-muted);
            color: var(--text-primary);
        }

        /* Image info table */
        .page-group {
            margin-bottom: 20px;
        }

        .page-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            background: var(--bg-tertiary);
            border-radius: 8px 8px 0 0;
            border: 1px solid var(--border-color);
            border-bottom: none;
        }

        .page-number {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            color: var(--accent-primary);
        }

        .page-image-count {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .image-table-container {
            overflow-x: auto;
            border: 1px solid var(--border-color);
            border-radius: 0 0 8px 8px;
        }

        .image-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .image-table th {
            background: var(--bg-secondary);
            padding: 9px 12px;
            text-align: left;
            font-weight: 500;
            color: var(--text-secondary);
            white-space: nowrap;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .image-table td {
            padding: 9px 12px;
            border-bottom: 1px solid var(--border-color);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.78rem;
            color: var(--text-primary);
            white-space: nowrap;
        }

        .image-table tr:last-child td {
            border-bottom: none;
        }

        .image-table tr:hover td {
            background: rgba(88, 166, 255, 0.03);
        }

        .type-badge {
            display: inline-block;
            padding: 2px 7px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 500;
            text-transform: uppercase;
        }

        .type-badge.image {
            background: rgba(63, 185, 80, 0.12);
            color: var(--success);
        }

        .type-badge.smask {
            background: rgba(210, 153, 34, 0.12);
            color: var(--warning);
        }

        /* Large image indicators */
        .size-badge {
            display: block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 2px;
        }
        
        .size-badge:last-child {
            margin-bottom: 0;
        }

        .image-table th:last-child,
        .image-table td:last-child {
            width: 70px;
            min-width: 70px;
        }

        .size-badge.top-dims {
            background: rgba(9, 105, 218, 0.12);
            color: var(--accent-primary);
        }

        .size-badge.top-size {
            background: rgba(130, 80, 223, 0.12);
            color: #8250df;
        }

        .image-row-highlight {
            background: rgba(9, 105, 218, 0.04) !important;
        }

        .image-row-highlight:hover {
            background: rgba(9, 105, 218, 0.08) !important;
        }

        /* Percentage pie chart */
        .percent-cell {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
        }

        .percent-pie {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            position: relative;
        }

        .percent-pie-inner {
            position: absolute;
            inset: 6px;
            border-radius: 50%;
            background: var(--bg-secondary);
        }

        .percent-text {
            font-size: 11px;
            font-weight: 600;
            opacity: 0.9;
        }

        /* Clickable top 5 items */
        .largest-image-item {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .largest-image-item:hover {
            background: var(--bg-tertiary);
            transform: translateX(4px);
        }

        .dpi-value {
            font-weight: 700;
            font-size: 1.1rem;
        }

        .dpi-high {
            color: var(--success);
        }

        .dpi-medium {
            color: var(--warning);
        }

        .dpi-low {
            color: var(--error);
        }

        .dpi-na {
            color: var(--text-muted);
            font-style: italic;
        }

        /* Thumbnail */
        .preview-cell {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .thumbnail-wrapper {
            position: relative;
        }

        .img-thumbnail {
            width: 72px;
            height: 72px;
            object-fit: contain;
            border-radius: 4px;
            background: var(--bg-tertiary);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .img-thumbnail:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .img-thumbnail-placeholder {
            width: 72px;
            height: 72px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            border-radius: 4px;
            color: var(--text-muted);
            font-size: 18px;
        }

        .img-thumbnail-loading {
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 0.8; }
        }

        /* Action buttons */
        .action-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            text-decoration: none;
        }

        .action-btn-download {
            background: rgba(88, 166, 255, 0.12);
            color: var(--accent-primary);
        }

        .action-btn-download:hover {
            background: rgba(88, 166, 255, 0.25);
        }

        /* Modal for full image view */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal-content {
            max-width: 90vw;
            max-height: 90vh;
            position: relative;
        }

        .modal-image {
            max-width: 100%;
            max-height: 85vh;
            border-radius: 8px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .modal-close {
            position: absolute;
            top: -40px;
            right: 0;
            background: var(--bg-tertiary);
            border: none;
            color: var(--text-primary);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .modal-close:hover {
            background: var(--bg-secondary);
        }

        .modal-info {
            margin-top: 12px;
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        /* Error state */
        .error-message {
            display: none;
            background: rgba(248, 81, 73, 0.1);
            border: 1px solid rgba(248, 81, 73, 0.2);
            border-radius: 10px;
            padding: 14px 18px;
            color: var(--error);
            margin-top: 18px;
            font-size: 0.9rem;
        }

        .error-message.visible {
            display: block;
        }

        /* Loading state */
        .loading-spinner {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid var(--bg-primary);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* No images state */
        .no-images {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .no-images-icon {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 40px 24px;
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        footer a {
            color: var(--accent-primary);
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }

        /* Responsive */
        @media (max-width: 700px) {
            h1 {
                font-size: 1.75rem;
            }

            .card {
                padding: 20px;
            }

            .drop-zone {
                padding: 12px 14px;
            }

            .results-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .results-summary {
                gap: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="bg-decoration">
        <div class="grid-pattern"></div>
    </div>

    <div class="container">
        <header>
            <p class="instructions" style="color: #b0b0c0; font-size: 0.95rem; margin-top: 5px; line-height: 1.6;  margin-left: auto; margin-right: auto;">
                <strong style="color: #8a8a9a;">How to use:</strong> Upload a PDF to scan all embedded images. 
                View DPI, dimensions, and file sizes for each image. Click any thumbnail to preview full size, 
                or download individual images. Use the summary to identify large images that may need optimization.
            </p>
        </header>

        <main id="main-content">
            <!-- Upload Card -->
            <div class="card" id="upload-card">
                <div class="card-title">Upload PDF</div>
                
                <div class="drop-zone" id="drop-zone">
                    <div class="drop-zone-content">
                        <div class="drop-icon">ðŸ“„</div>
                        <div class="drop-text">Drop PDF here <span class="drop-subtext">or click to browse</span></div>
                    </div>
                    <input type="file" class="file-input" id="file-input" accept=".pdf,application/pdf">
                </div>

                <div class="file-info" id="file-info">
                    <div class="file-icon">ðŸ“„</div>
                    <div class="file-details">
                        <div class="file-name" id="file-name">document.pdf</div>
                        <div class="file-size" id="file-size">2.4 MB</div>
                    </div>
                    <button class="file-remove" id="file-remove" title="Remove file">âœ•</button>
                </div>

                <div class="options-row">
                    <label class="option-item">
                        <input type="checkbox" id="exclude-smask" checked>
                        <span>Exclude SMASK (transparency masks)</span>
                    </label>
                </div>

                <!-- Process Button -->
                <button class="btn-primary" id="analyze-btn" disabled style="margin-top: 20px;">
                    <span id="btn-text">Analyze PDF</span>
                    <span id="btn-spinner" class="loading-spinner" style="display: none;"></span>
                </button>

                <!-- Progress -->
                <div class="progress-container" id="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    <div class="progress-text" id="progress-text">Analyzing...</div>
                </div>

                <!-- Error -->
                <div class="error-message" id="error-message"></div>
            </div>

            <!-- Results -->
            <div class="card results" id="results">
                <div class="results-header">
                    <div class="results-title">
                        <span class="results-title-icon">ðŸ“Š</span>
                        Analysis Results
                    </div>
                    <button class="btn-reset" id="reset-btn">
                        â†º Analyze Another
                    </button>
                </div>

                <!-- Summary Cards -->
                <div class="summary-cards" id="summary-cards">
                    <div class="summary-card">
                        <div class="summary-card-title">PDF Summary</div>
                        <div class="compact-summary">
                            <div class="compact-row">
                                <span class="compact-label">File</span>
                                <span class="compact-value" id="summary-filename">-</span>
                            </div>
                            <div class="compact-row">
                                <span class="compact-label">Size</span>
                                <span class="compact-value" id="summary-filesize">-</span>
                                <span class="compact-sep">â€¢</span>
                                <span class="compact-label">Pages</span>
                                <span class="compact-value highlight" id="stat-pages">-</span>
                                <span class="compact-sep">â€¢</span>
                                <span class="compact-label">Images</span>
                                <span class="compact-value highlight" id="stat-images">-</span>
                            </div>
                            <div class="compact-divider"></div>
                            <div class="dpi-section-label">DPI</div>
                            <div class="dpi-section-desc">Median = typical quality of this PDF â€¢ High = highest DPI found â€¢ Low = lowest DPI found</div>
                            <div class="compact-group dpi-group">
                                <span class="dpi-stat">
                                    <span class="dpi-stat-label">Median</span>
                                    <span class="dpi-stat-value" id="summary-median-dpi">-</span>
                                </span>
                                <span class="dpi-stat">
                                    <span class="dpi-stat-label">High</span>
                                    <span class="dpi-stat-value" id="summary-highest-dpi">-</span>
                                </span>
                                <span class="dpi-stat">
                                    <span class="dpi-stat-label">Low</span>
                                    <span class="dpi-stat-value" id="summary-lowest-dpi">-</span>
                                </span>
                            </div>
                            <div class="compact-divider"></div>
                            <div class="dpi-section-label" style="font-size: 0.9rem;">Distribution</div>
                            <div class="dpi-chart dpi-chart-compact" id="dpi-distribution-chart">
                                <div class="dpi-chart-empty">No images analyzed</div>
                            </div>
                        </div>
                    </div>
                    <div class="summary-card summary-card-wide">
                        <div class="summary-card-title">Top Largest Images(Dimensions)</div>
                        <div class="summary-card-hint">Click to jump to image in table</div>
                        <div class="largest-images-grid" id="largest-images-grid">
                        </div>
                    </div>
                    <div class="summary-card summary-card-wide">
                        <div class="summary-card-title">Top Largest Images (Size)</div>
                        <div class="summary-card-hint">Click to jump to image in table</div>
                        <div class="largest-images-grid" id="largest-images-size-grid">
                        </div>
                    </div>
                </div>

                <div class="table-hint">ðŸ’¡ Click on image preview to view full size â€¢ Click download icon to download image</div>
                <div id="image-info-content"></div>
            </div>
        </main>

    </div>

    <!-- Image Modal -->
    <div class="modal-overlay" id="image-modal">
        <div class="modal-content">
            <button class="modal-close" id="modal-close">âœ•</button>
            <img class="modal-image" id="modal-image" src="" alt="Full size image">
            <div class="modal-info" id="modal-info"></div>
        </div>
    </div>

    <script type="module">
        import init, { get_pdf_image_info, get_image_data } from './pkg/resample_pdf.js';

        let wasmReady = false;
        let selectedFile = null;
        let pdfBytes = null;
        let imageCache = new Map(); // Cache for loaded images: objectId -> { url, format, mimeType }

        // DOM elements
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const fileInfo = document.getElementById('file-info');
        const fileName = document.getElementById('file-name');
        const fileSize = document.getElementById('file-size');
        const fileRemove = document.getElementById('file-remove');
        const analyzeBtn = document.getElementById('analyze-btn');
        const btnText = document.getElementById('btn-text');
        const btnSpinner = document.getElementById('btn-spinner');
        const progressContainer = document.getElementById('progress-container');
        const progressFill = document.getElementById('progress-fill');
        const progressText = document.getElementById('progress-text');
        const errorMessage = document.getElementById('error-message');
        const results = document.getElementById('results');
        const uploadCard = document.getElementById('upload-card');
        const resetBtn = document.getElementById('reset-btn');
        const imageModal = document.getElementById('image-modal');
        const modalImage = document.getElementById('modal-image');
        const modalInfo = document.getElementById('modal-info');
        const modalClose = document.getElementById('modal-close');

        // Initialize WASM
        async function initWasm() {
            try {
                await init();
                wasmReady = true;
                console.log('WASM initialized successfully');
            } catch (e) {
                console.error('Failed to initialize WASM:', e);
                showError('Failed to load the PDF analyzer. Please refresh the page.');
            }
        }

        initWasm();

        // Format file size
        function formatSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        }

        // Get DPI class for coloring
        function getDpiClass(dpi) {
            if (dpi >= 200) return 'dpi-high';
            if (dpi >= 100) return 'dpi-medium';
            return 'dpi-low';
        }

        // Get gradient color from green (0%) to red (50%+)
        function getPercentColor(percent) {
            // Scale so 50% = full red
            const p = Math.min(50, Math.max(0, percent)) / 50;
            const r = Math.round(220 * p);
            const g = Math.round(180 * (1 - p));
            return `rgb(${r}, ${g}, 0)`;
        }

        // Calculate median of an array
        function median(arr) {
            if (arr.length === 0) return null;
            const sorted = [...arr].sort((a, b) => a - b);
            const mid = Math.floor(sorted.length / 2);
            return sorted.length % 2 !== 0
                ? sorted[mid]
                : (sorted[mid - 1] + sorted[mid]) / 2;
        }

        // Update summary cards with statistics
        function updateSummaryCards(pages, totalImages) {
            // File info
            document.getElementById('summary-filename').textContent = selectedFile ? selectedFile.name : '-';
            document.getElementById('summary-filesize').textContent = selectedFile ? formatSize(selectedFile.size) : '-';

            // Collect all images with page info
            const excludeSmask = document.getElementById('exclude-smask').checked;
            const allImages = [];

            pages.forEach(page => {
                page.images.forEach(img => {
                    if (excludeSmask && img.type === 'smask') return;
                    allImages.push({ ...img, pageNumber: page.page });
                });
            });

            // DPI statistics (use max of X and Y for each image)
            const dpiMaxValues = allImages
                .filter(img => img.dpiX && img.dpiY)
                .map(img => Math.max(img.dpiX, img.dpiY));

            // Helper to get DPI color class
            const getDpiColorClass = (dpi) => {
                if (dpi >= 300) return 'dpi-high';
                if (dpi >= 150) return 'dpi-good';
                if (dpi >= 72) return 'dpi-medium';
                return 'dpi-low';
            };

            if (dpiMaxValues.length > 0) {
                const medianDpi = Math.round(median(dpiMaxValues));
                const highDpi = Math.round(Math.max(...dpiMaxValues));
                const lowDpi = Math.round(Math.min(...dpiMaxValues));

                const medianEl = document.getElementById('summary-median-dpi');
                const highEl = document.getElementById('summary-highest-dpi');
                const lowEl = document.getElementById('summary-lowest-dpi');

                medianEl.textContent = medianDpi + ' DPI';
                medianEl.className = 'dpi-stat-value ' + getDpiColorClass(medianDpi);

                highEl.textContent = highDpi + ' DPI';
                highEl.className = 'dpi-stat-value ' + getDpiColorClass(highDpi);

                lowEl.textContent = lowDpi + ' DPI';
                lowEl.className = 'dpi-stat-value ' + getDpiColorClass(lowDpi);
            } else {
                document.getElementById('summary-median-dpi').textContent = '-';
                document.getElementById('summary-highest-dpi').textContent = '-';
                document.getElementById('summary-lowest-dpi').textContent = '-';
            }

            // DPI Distribution Chart
            const dpiChart = document.getElementById('dpi-distribution-chart');
            if (dpiMaxValues.length > 0) {
                // Count images in each DPI range
                const dpiRanges = {
                    low: { count: 0, label: '<72 (Low)', class: 'dpi-low' },
                    medium: { count: 0, label: '72-149 (Screen)', class: 'dpi-medium' },
                    good: { count: 0, label: '150-299 (Good)', class: 'dpi-good' },
                    high: { count: 0, label: '300+ (Print)', class: 'dpi-high' }
                };

                dpiMaxValues.forEach(dpi => {
                    if (dpi >= 300) dpiRanges.high.count++;
                    else if (dpi >= 150) dpiRanges.good.count++;
                    else if (dpi >= 72) dpiRanges.medium.count++;
                    else dpiRanges.low.count++;
                });

                const maxCount = Math.max(...Object.values(dpiRanges).map(r => r.count));
                const total = dpiMaxValues.length;

                let chartHtml = '';
                ['high', 'good', 'medium', 'low'].forEach(key => {
                    const range = dpiRanges[key];
                    const percent = maxCount > 0 ? (range.count / maxCount) * 100 : 0;
                    const pctOfTotal = total > 0 ? ((range.count / total) * 100).toFixed(0) : 0;
                    chartHtml += `
                        <div class="dpi-chart-bar">
                            <span class="dpi-chart-label">${range.label}</span>
                            <div class="dpi-chart-track">
                                <div class="dpi-chart-fill ${range.class}" style="width: ${percent}%"></div>
                            </div>
                            <span class="dpi-chart-value ${range.class}">${range.count} (${pctOfTotal}%)</span>
                        </div>
                    `;
                });
                dpiChart.innerHTML = chartHtml;
            } else {
                dpiChart.innerHTML = '<div class="dpi-chart-empty">No images with DPI info</div>';
            }

            // Top 5 largest images by pixel count
            const sortedByPixels = allImages
                .filter(img => img.width && img.height)
                .sort((a, b) => (b.width * b.height) - (a.width * a.height))
                .slice(0, 6);

            // Top 6 largest images by file size
            const sortedByFileSize = allImages
                .filter(img => img.size)
                .sort((a, b) => b.size - a.size)
                .slice(0, 6);

            // Populate pixel-based grid
            const largestGrid = document.getElementById('largest-images-grid');
            largestGrid.innerHTML = '';

            if (sortedByPixels.length === 0) {
                largestGrid.innerHTML = '<div style="color: var(--text-muted); font-size: 0.85rem;">No images found</div>';
            } else {
                sortedByPixels.forEach(img => {
                    const safeObjectId = img.objectId.replace(/"/g, '&quot;');
                    const rowId = `img-row-${img.objectId.replace(' ', '-')}`;
                    const item = document.createElement('div');
                    item.className = 'largest-image-item';
                    item.title = 'Click to jump to image';
                    item.innerHTML = `
                        <div class="largest-image-thumb-placeholder" data-largest-id="${safeObjectId}">ðŸ–¼</div>
                        <img class="largest-image-thumb" data-largest-id="${safeObjectId}" style="display: none;">
                        <div class="largest-image-info">
                            <span class="page-num">Page ${img.pageNumber}</span>
                            <span class="dims">${img.width} Ã— ${img.height}</span>
                        </div>
                    `;
                    item.addEventListener('click', () => scrollToImage(rowId));
                    largestGrid.appendChild(item);
                });
            }

            // Populate file size-based grid
            const sizeGrid = document.getElementById('largest-images-size-grid');
            sizeGrid.innerHTML = '';

            if (sortedByFileSize.length === 0) {
                sizeGrid.innerHTML = '<div style="color: var(--text-muted); font-size: 0.85rem;">No images found</div>';
            } else {
                sortedByFileSize.forEach(img => {
                    const safeObjectId = img.objectId.replace(/"/g, '&quot;');
                    const rowId = `img-row-${img.objectId.replace(' ', '-')}`;
                    const item = document.createElement('div');
                    item.className = 'largest-image-item';
                    item.title = 'Click to jump to image';
                    item.innerHTML = `
                        <div class="largest-image-thumb-placeholder" data-largest-id="${safeObjectId}">ðŸ–¼</div>
                        <img class="largest-image-thumb" data-largest-id="${safeObjectId}" style="display: none;">
                        <div class="largest-image-info">
                            <span class="page-num">Page ${img.pageNumber}</span>
                            <span class="dims">${formatSize(img.size)}</span>
                        </div>
                    `;
                    item.addEventListener('click', () => scrollToImage(rowId));
                    sizeGrid.appendChild(item);
                });
            }

            // Load thumbnails for largest images (both grids)
            loadLargestImageThumbnails();
        }

        // Scroll to image row and highlight it
        function scrollToImage(rowId) {
            const row = document.getElementById(rowId);
            if (row) {
                row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // Flash highlight effect
                row.style.transition = 'background-color 0.3s ease';
                row.style.backgroundColor = 'rgba(9, 105, 218, 0.15)';
                setTimeout(() => {
                    row.style.backgroundColor = '';
                }, 1500);
            }
        }

        // Load thumbnails for the largest images in summary
        async function loadLargestImageThumbnails() {
            const placeholders = document.querySelectorAll('.largest-image-thumb-placeholder');
            
            for (const placeholder of placeholders) {
                const objectId = placeholder.dataset.largestId;
                // Find the sibling img element (next element after placeholder)
                const img = placeholder.nextElementSibling;
                if (img && img.classList.contains('largest-image-thumb') && pdfBytes) {
                    try {
                        const result = get_image_data(pdfBytes, objectId);
                        const blob = new Blob([result.data], { type: result.mime_type });
                        img.src = URL.createObjectURL(blob);
                        img.onload = () => {
                            placeholder.style.display = 'none';
                            img.style.display = 'block';
                        };
                    } catch (e) {
                        placeholder.textContent = 'âš ';
                        placeholder.title = 'Failed to load';
                    }
                }
            }
        }

        // Show error
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.add('visible');
        }

        // Hide error
        function hideError() {
            errorMessage.classList.remove('visible');
        }

        // Set selected file
        function setFile(file) {
            if (!file || file.type !== 'application/pdf') {
                showError('Please select a valid PDF file.');
                return;
            }

            selectedFile = file;
            fileName.textContent = file.name;
            fileSize.textContent = formatSize(file.size);
            fileInfo.classList.add('visible');
            analyzeBtn.disabled = !wasmReady;
            hideError();

            // Auto-start analysis
            if (wasmReady) {
                analyzePdf();
            }
        }

        // Clear file
        function clearFile() {
            selectedFile = null;
            pdfBytes = null;
            imageCache.clear();
            fileInput.value = '';
            fileInfo.classList.remove('visible');
            analyzeBtn.disabled = true;
            hideError();
        }

        // Reset to initial state
        function reset() {
            clearFile();
            results.classList.remove('visible');
            uploadCard.style.display = 'block';
            progressContainer.classList.remove('visible');
            progressFill.style.width = '0%';
        }

        // Load image and return cached data { url, format, mimeType }
        async function loadImage(objectId) {
            if (imageCache.has(objectId)) {
                return imageCache.get(objectId);
            }

            try {
                const result = get_image_data(pdfBytes, objectId);
                const blob = new Blob([result.data], { type: result.mime_type });
                const url = URL.createObjectURL(blob);
                const cached = { url, format: result.format, mimeType: result.mime_type };
                imageCache.set(objectId, cached);
                return cached;
            } catch (e) {
                console.error('Failed to load image:', objectId, e);
                return null;
            }
        }

        // Load thumbnail for an image
        async function loadThumbnail(objectId, imgElement, placeholderElement) {
            const cached = await loadImage(objectId);
            if (cached) {
                imgElement.src = cached.url;
                imgElement.style.display = 'block';
                placeholderElement.style.display = 'none';
            } else {
                placeholderElement.textContent = 'âš ï¸';
                placeholderElement.classList.remove('img-thumbnail-loading');
            }
        }

        // Show image in modal
        async function showImageModal(objectId, imgInfo) {
            const cached = await loadImage(objectId);
            if (cached) {
                modalImage.src = cached.url;
                const formatLabel = cached.format.toUpperCase();
                modalInfo.textContent = `${imgInfo.width} Ã— ${imgInfo.height} px â€¢ ${imgInfo.colorSpace} â€¢ ${formatLabel}`;
                imageModal.classList.add('visible');
            }
        }

        // Download image
        async function downloadImage(objectId, imgInfo, pageNum) {
            const cached = await loadImage(objectId);
            if (cached) {
                const ext = cached.format; // 'jpeg' or 'png'
                const a = document.createElement('a');
                a.href = cached.url;
                a.download = `page${pageNum}_${objectId.replace(' ', '_')}.${ext}`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }
        }

        // Render image info table
        function renderImageInfo(pages) {
            const container = document.getElementById('image-info-content');
            
            if (!pages || pages.length === 0) {
                container.innerHTML = `
                    <div class="no-images">
                        <div class="no-images-icon">ðŸ“­</div>
                        <div>No images found in this PDF</div>
                    </div>
                `;
                document.getElementById('stat-pages').textContent = '0';
                document.getElementById('stat-images').textContent = '0';
                updateSummaryCards([], 0);
                return;
            }

            // Count totals and collect all images
            let totalImages = 0;
            const excludeSmask = document.getElementById('exclude-smask').checked;
            const allImages = [];
            pages.forEach(p => {
                p.images.forEach(img => {
                    if (excludeSmask && img.type === 'smask') return;
                    totalImages++;
                    allImages.push({ ...img, pageNumber: p.page });
                });
            });
            
            document.getElementById('stat-pages').textContent = pages.length;
            document.getElementById('stat-images').textContent = totalImages;

            // Calculate top 6 by dimensions and by size for highlighting
            const top6Dims = new Set(
                allImages
                    .filter(img => img.width && img.height)
                    .sort((a, b) => (b.width * b.height) - (a.width * a.height))
                    .slice(0, 6)
                    .map(img => img.objectId)
            );
            const top6Size = new Set(
                allImages
                    .filter(img => img.size)
                    .sort((a, b) => b.size - a.size)
                    .slice(0, 6)
                    .map(img => img.objectId)
            );

            // Update summary cards
            updateSummaryCards(pages, totalImages);

            let html = '';
            
            for (const page of pages) {
                const pageImageCount = excludeSmask 
                    ? page.images.filter(img => img.type !== 'smask').length 
                    : page.images.length;
                    
                html += `
                    <div class="page-group">
                        <div class="page-header">
                            <span class="page-number">Page ${page.page}</span>
                            <span class="page-image-count">${pageImageCount} image${pageImageCount !== 1 ? 's' : ''}</span>
                        </div>
                        <div class="image-table-container">
                            <table class="image-table">
                                <thead>
                                    <tr>
                                        <th>Preview</th>
                                        <th>#</th>
                                        <th>Type</th>
                                        <th>Image Size</th>
                                        <th>Display Size</th>
                                        <th>Format</th>
                                        <th>Size</th>
                                        <th>Size(%)</th>
                                        <th>DPI</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                const pdfSize = selectedFile ? selectedFile.size : 1;
                let displayIdx = 0;
                
                page.images.forEach((img) => {
                    // Skip SMASK if excluded
                    if (excludeSmask && img.type === 'smask') return;
                    displayIdx++;
                    
                    let dpiDisplay;
                    if (img.dpiX && img.dpiY) {
                        const maxDpi = Math.max(img.dpiX, img.dpiY);
                        const dpiClass = getDpiClass(maxDpi);
                        dpiDisplay = `<span class="dpi-value ${dpiClass}">${maxDpi.toFixed(0)}</span>`;
                    } else {
                        dpiDisplay = `<span class="dpi-na">â€”</span>`;
                    }
                    
                    // Calculate display size from pixel dimensions and DPI
                    // displayPoints = pixels * 72 / dpi
                    let displaySizeStr = 'â€”';
                    if (img.dpiX && img.dpiY && img.dpiX > 0 && img.dpiY > 0) {
                        const displayW = Math.round(img.width * 72 / img.dpiX);
                        const displayH = Math.round(img.height * 72 / img.dpiY);
                        displaySizeStr = `${displayW}Ã—${displayH}`;
                    }
                    
                    const typeClass = img.type === 'smask' ? 'smask' : 'image';
                    const safeObjectId = img.objectId.replace(/"/g, '&quot;');
                    const imgData = JSON.stringify(img).replace(/"/g, '&quot;');
                    const rowId = `img-row-${img.objectId.replace(' ', '-')}`;
                    
                    // Check if this image is in top 6 lists
                    const isTopDims = top6Dims.has(img.objectId);
                    const isTopSize = top6Size.has(img.objectId);
                    const rowClass = (isTopDims || isTopSize) ? 'image-row-highlight' : '';
                    
                    // Build badges
                    let badges = '';
                    if (isTopDims) badges += '<span class="size-badge top-dims">Top Dims</span>';
                    if (isTopSize) badges += '<span class="size-badge top-size">Top Size</span>';
                    
                    // Calculate size percentage
                    const sizePercent = img.size ? (img.size / pdfSize * 100) : 0;
                    const percentColor = getPercentColor(sizePercent);
                    
                    html += `
                        <tr id="${rowId}" class="${rowClass}">
                            <td>
                                <div class="preview-cell">
                                    <div class="thumbnail-wrapper">
                                        <div class="img-thumbnail-placeholder img-thumbnail-loading" data-object-id="${safeObjectId}">ðŸ–¼</div>
                                        <img class="img-thumbnail" data-object-id="${safeObjectId}" style="display: none;" 
                                             onclick="window.showModal('${safeObjectId}', ${imgData})" 
                                             title="Click to view full size">
                                    </div>
                                    <button class="action-btn action-btn-download" 
                                            onclick="window.downloadImg('${safeObjectId}', ${imgData}, ${page.page})" 
                                            title="Download as ${img.filter === 'DCTDecode' ? 'JPEG' : 'PNG'}"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></button>
                                </div>
                            </td>
                            <td>${displayIdx}</td>
                            <td><span class="type-badge ${typeClass}">${img.type}</span></td>
                            <td>${img.width}Ã—${img.height}</td>
                            <td>${displaySizeStr}</td>
                            <td>${img.colorSpace}<br>${img.bpc}bpc<br>${img.filter}</td>
                            <td>${formatSize(img.size)}</td>
                            <td>
                                <div class="percent-cell">
                                    <div class="percent-pie" style="background: conic-gradient(${percentColor} 0% ${sizePercent}%, var(--bg-tertiary) ${sizePercent}% 100%);"><div class="percent-pie-inner"></div></div>
                                    <span class="percent-text" style="color: ${percentColor};">${sizePercent.toFixed(1)}%</span>
                                </div>
                            </td>
                            <td>${dpiDisplay}</td>
                            <td>${badges}</td>
                        </tr>
                    `;
                });
                
                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;

            // Load thumbnails asynchronously
            loadAllThumbnails();
        }

        // Load all thumbnails
        async function loadAllThumbnails() {
            const placeholders = document.querySelectorAll('.img-thumbnail-placeholder');
            
            for (const placeholder of placeholders) {
                const objectId = placeholder.dataset.objectId;
                // Use nextElementSibling to get the paired img, not querySelector which only finds the first match
                const img = placeholder.nextElementSibling;
                if (img && img.classList.contains('img-thumbnail')) {
                    loadThumbnail(objectId, img, placeholder);
                }
            }
        }

        // Expose functions to window for onclick handlers
        window.showModal = (objectId, imgInfo) => showImageModal(objectId, imgInfo);
        window.downloadImg = (objectId, imgInfo, pageNum) => downloadImage(objectId, imgInfo, pageNum);

        // Analyze PDF
        async function analyzePdf() {
            if (!selectedFile || !wasmReady) return;

            hideError();
            analyzeBtn.disabled = true;
            btnText.textContent = 'Analyzing...';
            btnSpinner.style.display = 'inline-block';
            progressContainer.classList.add('visible');
            progressFill.style.width = '30%';
            progressText.textContent = 'Reading PDF...';

            try {
                // Read file and store for later image extraction
                const arrayBuffer = await selectedFile.arrayBuffer();
                pdfBytes = new Uint8Array(arrayBuffer);

                progressFill.style.width = '60%';
                progressText.textContent = 'Scanning images...';

                // Get image info
                const imageInfoJson = get_pdf_image_info(pdfBytes);
                const pages = JSON.parse(imageInfoJson);

                progressFill.style.width = '100%';
                progressText.textContent = 'Done!';

                // Render results
                renderImageInfo(pages);

                // Show results
                setTimeout(() => {
                    progressContainer.classList.remove('visible');
                    uploadCard.style.display = 'none';
                    results.classList.add('visible');
                }, 300);

            } catch (e) {
                console.error('Analysis failed:', e);
                showError('Failed to analyze PDF: ' + (e.message || e));
                progressContainer.classList.remove('visible');
            } finally {
                analyzeBtn.disabled = false;
                btnText.textContent = 'Analyze PDF';
                btnSpinner.style.display = 'none';
            }
        }

        // Event listeners
        dropZone.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                setFile(e.target.files[0]);
            }
        });

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            if (e.dataTransfer.files.length > 0) {
                setFile(e.dataTransfer.files[0]);
            }
        });

        fileRemove.addEventListener('click', (e) => {
            e.stopPropagation();
            clearFile();
        });

        analyzeBtn.addEventListener('click', analyzePdf);
        resetBtn.addEventListener('click', reset);

        // Modal event handlers
        modalClose.addEventListener('click', () => {
            imageModal.classList.remove('visible');
        });

        imageModal.addEventListener('click', (e) => {
            if (e.target === imageModal) {
                imageModal.classList.remove('visible');
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && imageModal.classList.contains('visible')) {
                imageModal.classList.remove('visible');
            }
        });

        // Prevent default drag behavior on window
        window.addEventListener('dragover', (e) => e.preventDefault());
        window.addEventListener('drop', (e) => e.preventDefault());
    </script>
</body>
</html>

